{% set trait_effects_dict = {} %}
{% for trait in traits %}
    {% set _ = trait_effects_dict.update({trait['name']: trait['effect']}) %}
{% endfor %}

{% set ability_effects_dict = {} %}
{% for ab in abilities %}
    {% set _ = ability_effects_dict.update({ab['name']: ab['effect']}) %}
{% endfor %}

<!DOCTYPE html>
<html>
<head>
    <title>Edit Character - {{ character['Name'] }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .sheet-box {
            border: 2px solid #222;
            width: 520px;
            margin: 36px auto 24px auto;
            padding: 0;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px #0002;
            overflow: hidden;
        }
        .sheet-row, .sheet-header, .sheet-section {
            border-bottom: 1.5px solid #bbb;
            padding: 10px 18px;
        }
        .sheet-header { text-align: center; font-weight: bold; font-size: 1.18em; background: #f8f8f8; border-bottom: 2px solid #222; }
        .sheet-table { width: 100%; border-collapse: collapse; }
        .sheet-table th, .sheet-table td {
            border: 1px solid #000;
            text-align: center;
            padding: 2px 4px;
        }
        .sheet-section-title { font-weight: bold; margin-top: 4px; margin-bottom: 6px; }
        .sheet-flex { display: flex; gap: 0; }
        .sheet-half { width: 50%; border-right: 1.5px solid #bbb; box-sizing: border-box; background: #fafbfc; }
        .sheet-half:last-child { border-right: none; }
        .sheet-quarter-inner { padding: 10px 12px; min-height: 40px; }
        .sheet-list { min-height: 40px; margin: 0; padding-left: 16px; }
        .sheet-list li { text-align: left; }
        .sheet-label { font-weight: bold; }
        .sheet-row:last-child, .sheet-section:last-child { border-bottom: none; }
        .sheet-nav { text-align: center; margin: 22px 0 0 0; }
        .btn { padding: 8px 18px; border-radius: 4px; border: none; background: #222; color: #fff; font-weight: bold; text-decoration: none; margin-right: 8px; }
        .btn:hover { background: #444; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #bbb;
            padding: 5px 7px;
            background: #f9f9f9;
        }
        /* Style for trait/ability dropdown options */
        select option {
            padding: 8px 6px;
            white-space: normal;
            min-height: 30px;
            line-height: 1.3;
        }
    </style>
</head>
<body style="background:#f4f4f4;">
<div style="text-align:center;margin-bottom:10px;font-size:1.1em;">
    <b>Warband Points Limit:</b> {{ warband_points }}
</div>

<form action="/edit_character/{{ warband }}/{{ character['Name'] }}" method="post" autocomplete="off">
    <div class="sheet-box">
        <div class="sheet-header">Edit Character: <input type="text" name="Name" value="{{ character['Name'] }}" style="width:120px; font-weight:bold; font-size:1em; border:1px solid #888; padding:2px 4px;"> </div>
        
        <div class="sheet-row">
            <span class="sheet-label">Points cost:</span>
            <input type="number" name="Points" value="{{ character['Points'] }}" style="width:60px;">
        </div>

        <div class="sheet-row">
            <table class="sheet-table">
                <tr><th>Agility</th><th>Shooting</th><th>Fighting</th><th>Psyche</th><th>Awareness</th></tr>
                <tr>
                    <td><input type="number" name="Agility" value="{{ character['Skills']['Agility'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Shooting" value="{{ character['Skills']['Shooting'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Fighting" value="{{ character['Skills']['Fighting'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Psyche" value="{{ character['Skills']['Psyche'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Awareness" value="{{ character['Skills']['Awareness'] }}" style="width:40px;"></td>
                </tr>
            </table>
        </div>

        <div class="sheet-row">
            <table class="sheet-table">
                <tr><td>Speed</td><td>Hit-points</td></tr>
                <tr>
                    <td><input type="number" name="Speed" value="{{ character['Speed'] }}" style="width:60px;"></td>
                    <td><input type="number" name="Hitpoints" value="{{ character['Hit-points'] }}" style="width:60px;"></td>
                </tr>
            </table>
        </div>
        
        <div class="sheet-section">
            <div class="sheet-section-title">Traits:</div>
            <div id="trait-list-box">
                <input type="hidden" name="Traits" id="traits-hidden-input" value="{{ character['Traits']|join(', ') }}">
                <ul id="trait-list" class="sheet-list" style="margin-bottom:6px;">
                    {% for trait in character['Traits'] %}
                    <li>
                        {{ trait }}
                        <button type="button" class="show-effect-btn" data-trait="{{ trait }}" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>
                        <button type="button" class="remove-trait-btn" data-trait="{{ trait }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>
                        <div class="trait-effect-inline" data-trait="{{ trait }}" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
                    </li>
                    {% else %}
                    <li>-</li>
                    {% endfor %}
                </ul>
                <button type="button" id="toggle-all-trait-effects" style="margin:6px 0 8px 0;padding:2px 12px;font-size:0.97em;">Show all trait effects</button>
                <div id="all-trait-effects" style="display:none;margin:8px 0 0 0;padding:8px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            </div>
            <div style="margin-top:8px;display:flex;align-items:center;">
                <label for="trait_select" style="margin-right:8px;white-space:nowrap;"><b>Add Trait:</b></label>
                <select id="trait_select" onchange="traitEffect();" style="flex-grow:1;margin-right:5px;">
                    <option value="">-- Select a trait --</option>
                    {% for trait in traits %}
                    <option value="{{ trait['name'] }}" data-effect="{{ trait['effect'] }}">{{ trait['name'] }} ({{ trait['cost'] }}) [{{ trait['effect'] }}]</option>
                    {% endfor %}
                </select>
                <button type="button" id="add-trait-btn">Add</button>
                <div id="trait-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;width:100%;"></div>
            </div>
        </div>
        
        <div class="sheet-section">
            <div class="sheet-section-title">Abilities:</div>
            <div id="ability-list-box">
                <input type="hidden" name="Abilities" id="abilities-hidden-input" value="{{ character['Abilities']|join(', ') }}">
                <ul id="ability-list" class="sheet-list" style="margin-bottom:6px;">
                {% for ab in character['Abilities'] %}
                    <li>
                        {{ ab }}
                        <button type="button" class="show-ability-effect-btn" data-ability="{{ ab }}" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>
                        <button type="button" class="remove-ability-btn" data-ability="{{ ab }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>
                        <div class="ability-effect-inline" data-ability="{{ ab }}" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
                    </li>
                {% else %}
                    <li>-</li>
                {% endfor %}
                </ul>
                <button type="button" id="toggle-all-ability-effects" style="margin:6px 0 8px 0;padding:2px 12px;font-size:0.97em;">Show all ability effects</button>
                <div id="all-ability-effects" style="display:none;margin:8px 0 0 0;padding:8px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            </div>
            <div style="margin-top:8px;display:flex;align-items:center;">
                <label for="ability_select" style="margin-right:8px;white-space:nowrap;"><b>Add Ability:</b></label>
                <select id="ability_select" onchange="abilityEffect();" style="flex-grow:1;margin-right:5px;">
                    <option value="">-- Select an ability --</option>
                    {% for ab in abilities %}
                    <option value="{{ ab['name'] }}" data-effect="{{ ab['effect'] }}">{{ ab['name'] }} ({{ ab['cost'] }}) [{{ ab['effect'] }}]</option>
                    {% endfor %}
                </select>
                <button type="button" id="add-ability-btn">Add</button>
                <div id="ability-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;width:100%;"></div>
            </div>
        </div>
        
        <div style="margin-top:16px;">
            <textarea name="Notes" rows="3" style="width:100%;min-height:60px;resize:vertical;border-radius:4px;border:1px solid #bbb;padding:6px 8px;box-sizing:border-box;">{{ character['Notes'] if character['Notes'] is defined else '' }}</textarea>
        </div>

        <div style="margin-top:16px;text-align:right;">
            <button type="submit" style="padding:6px 12px;font-weight:bold;">Save Character</button>
        </div>
    </div>

<script id="trait-costs-json" type="application/json">
{
{% for trait in traits %}    "{{ trait['name'] }}": {{ trait['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>

<script id="ability-costs-json" type="application/json">
{
{% for ab in abilities %}    "{{ ab['name'] }}": {{ ab['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>

<script>
// Map trait and ability names to effects for quick lookup
const TRAIT_EFFECTS = {{ trait_effects_dict|tojson|safe }};
const ABILITY_EFFECTS = {{ ability_effects_dict|tojson|safe }};
const TRAIT_COSTS = JSON.parse(document.getElementById('trait-costs-json').textContent);
const ABILITY_COSTS = JSON.parse(document.getElementById('ability-costs-json').textContent);

document.addEventListener('DOMContentLoaded', function() {
    const traitSelect = document.getElementById('trait-select');
    const abilitySelect = document.getElementById('ability-select');
    const traitList = document.getElementById('trait-list');
    const abilityList = document.getElementById('ability-list');
    const traitInput = document.getElementById('traits-hidden-input');
    const abilityInput = document.getElementById('abilities-hidden-input');
    const toggleTraitBtn = document.getElementById('toggle-all-trait-effects');
    const toggleAbilityBtn = document.getElementById('toggle-all-ability-effects');
    const traitEffectsDiv = document.getElementById('all-trait-effects');
    const abilityEffectsDiv = document.getElementById('all-ability-effects');
    
    // Variables to track if effect tables are shown
    let traitEffectsShown = false;
    let abilityEffectsShown = false;
    
    // Trait effects toggle
    if (toggleTraitBtn && traitEffectsDiv) {
        toggleTraitBtn.addEventListener('click', function() {
            if (!traitEffectsShown) {
                updateTraitEffectsDisplay();
                traitEffectsDiv.style.display = 'block';
                toggleTraitBtn.textContent = 'Hide all trait effects';
                traitEffectsShown = true;
            } else {
                traitEffectsDiv.style.display = 'none';
                toggleTraitBtn.textContent = 'Show all trait effects';
                traitEffectsShown = false;
            }
        });
    }
    
    // Ability effects toggle
    if (toggleAbilityBtn && abilityEffectsDiv) {
        toggleAbilityBtn.addEventListener('click', function() {
            if (!abilityEffectsShown) {
                updateAbilityEffectsDisplay();
                abilityEffectsDiv.style.display = 'block';
                toggleAbilityBtn.textContent = 'Hide all ability effects';
                abilityEffectsShown = true;
            } else {
                abilityEffectsDiv.style.display = 'none';
                toggleAbilityBtn.textContent = 'Show all ability effects';
                abilityEffectsShown = false;
            }
        });
    }

    // Function to update trait effects display
    function updateTraitEffectsDisplay() {
        const traitNames = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).map(btn => btn.getAttribute('data-trait'));
        let html = '';
        traitNames.forEach(trait => {
            if (TRAIT_EFFECTS[trait]) {
                html += `<div style="margin-bottom:6px;"><b>${trait}</b>: ${TRAIT_EFFECTS[trait]}</div>`;
            }
        });
        traitEffectsDiv.innerHTML = html;
    }
    
    // Function to update ability effects display
    function updateAbilityEffectsDisplay() {
        const abilityNames = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).map(btn => btn.getAttribute('data-ability'));
        let html = '';
        abilityNames.forEach(ability => {
            if (ABILITY_EFFECTS[ability]) {
                html += `<div style="margin-bottom:6px;"><b>${ability}</b>: ${ABILITY_EFFECTS[ability]}</div>`;
            }
        });
        abilityEffectsDiv.innerHTML = html;
    }
    
    // --- TRAIT ADD/REMOVE ---
    function updateTraitsInput() {
        const traits = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).map(btn => btn.getAttribute('data-trait'));
        traitInput.value = traits.join(',');
        
        // Update trait effects display if it's visible
        if (traitEffectsShown) {
            updateTraitEffectsDisplay();
        }
    }
    
    // Event delegation for removing traits
    if (traitList) {
        traitList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-trait-btn')) {
                e.target.parentNode.remove();
                updateTraitsInput();
            } else if (e.target.classList.contains('show-effect-btn')) {
                const trait = e.target.getAttribute('data-trait');
                const effectDiv = e.target.parentNode.querySelector(`.trait-effect-inline[data-trait="${trait}"]`);
                if (effectDiv) {
                    if (effectDiv.style.display === 'none' || effectDiv.style.display === '') {
                        effectDiv.style.display = 'block';
                        effectDiv.textContent = TRAIT_EFFECTS[trait] || 'No effect description available.';
                    } else {
                        effectDiv.style.display = 'none';
                    }
                }
            }
        });
    }
    
    // Add trait button
    var addTraitBtn = document.getElementById('add-trait-btn');
    if (addTraitBtn) {
        addTraitBtn.addEventListener('click', function() {
            var select = document.getElementById('trait_select');
            var trait = select.value;
            if (!trait) return;
            // Prevent duplicates
            var exists = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).some(btn => btn.getAttribute('data-trait') === trait);
            if (exists) return;
            // Remove dash if present
            var traitList = document.getElementById('trait-list');
            if (traitList.children.length === 1 && traitList.children[0].textContent === '-') {
                traitList.removeChild(traitList.children[0]);
            }
            var li = document.createElement('li');
            li.innerHTML = '<div>' + trait + '</div>' + 
                '<button type="button" class="show-effect-btn" data-trait="' + trait + '" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>' +
                '<button type="button" class="remove-trait-btn" data-trait="' + trait + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>' +
                '<div class="trait-effect-inline" data-trait="' + trait + '" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>';
            traitList.appendChild(li);
            updateTraitsInput();
            select.selectedIndex = 0;
            document.getElementById('trait-effect-preview').style.display = 'none';
        });
    }
    
    // --- ABILITY ADD/REMOVE ---
    function updateAbilitiesInput() {
        var abilities = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn'))
            .map(btn => btn.getAttribute('data-ability'));
        abilityInput.value = abilities.join(', ');
        updatePoints();
        
        // Update ability effects display if it's visible
        if (abilityEffectsShown) {
            updateAbilityEffectsDisplay();
        }
    }
    
    // Event delegation for ability removal
    document.getElementById('ability-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ability-btn')) {
            var li = e.target.parentElement;
            li.parentElement.removeChild(li);
            updateAbilitiesInput();
            // If no abilities left, show a dash
            var abilityList = document.getElementById('ability-list');
            if (abilityList.children.length === 0) {
                var dash = document.createElement('li');
                dash.textContent = '-';
                abilityList.appendChild(dash);
            }
        } else if (e.target.classList.contains('show-ability-effect-btn')) {
            const ability = e.target.getAttribute('data-ability');
            const effectDiv = e.target.parentNode.querySelector(`.ability-effect-inline[data-ability="${ability}"]`);
            if (effectDiv) {
                if (effectDiv.style.display === 'none' || effectDiv.style.display === '') {
                    effectDiv.style.display = 'block';
                    effectDiv.textContent = ABILITY_EFFECTS[ability] || 'No effect description available.';
                } else {
                    effectDiv.style.display = 'none';
                }
            }
        }
    });
    
    // Add ability button
    var addAbilityBtn = document.getElementById('add-ability-btn');
    if (addAbilityBtn) {
        addAbilityBtn.addEventListener('click', function() {
            var select = document.getElementById('ability_select');
            var ability = select.value;
            if (!ability) return;
            // Prevent duplicates
            var exists = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).some(btn => btn.getAttribute('data-ability') === ability);
            if (exists) return;
            // Remove dash if present
            var abilityList = document.getElementById('ability-list');
            if (abilityList.children.length === 1 && abilityList.children[0].textContent === '-') {
                abilityList.removeChild(abilityList.children[0]);
            }
            var li = document.createElement('li');
            li.innerHTML = '<div>' + ability + '</div>' + 
                '<button type="button" class="show-ability-effect-btn" data-ability="' + ability + '" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>' +
                '<button type="button" class="remove-ability-btn" data-ability="' + ability + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>' +
                '<div class="ability-effect-inline" data-ability="' + ability + '" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>';
            abilityList.appendChild(li);
            updateAbilitiesInput();
            select.selectedIndex = 0;
            document.getElementById('ability-effect-preview').style.display = 'none';
        });
    }
    
    // Initialize points calculation
    updatePoints();
});

// Show effect preview for selected trait
function traitEffect() {
    var select = document.getElementById('trait_select');
    var preview = document.getElementById('trait-effect-preview');
    var effect = select.options[select.selectedIndex].getAttribute('data-effect');
    // We're already showing the effect in the dropdown option text,
    // so we'll only show the preview if explicitly wanted
    if (effect && select.value) {
        preview.style.display = 'none'; // Changed to hide by default since effect is in dropdown
    } else {
        preview.style.display = 'none';
        preview.textContent = '';
    }
}

// Show effect preview for selected ability
function abilityEffect() {
    var select = document.getElementById('ability_select');
    var preview = document.getElementById('ability-effect-preview');
    var effect = select.options[select.selectedIndex].getAttribute('data-effect');
    // We're already showing the effect in the dropdown option text,
    // so we'll only show the preview if explicitly wanted
    if (effect && select.value) {
        preview.style.display = 'none'; // Changed to hide by default since effect is in dropdown
    } else {
        preview.style.display = 'none';
        preview.textContent = '';
    }
}

// Calculate points based on traits and abilities
function updatePoints() {
    let basePoints = 10; // base cost
    let traitInput = document.getElementById('traits-hidden-input').value;
    let abilityInput = document.getElementById('abilities-hidden-input').value;
    let traits = traitInput.split(',').map(x => x.trim()).filter(x => x);
    let abilities = abilityInput.split(',').map(x => x.trim()).filter(x => x);
    let total = basePoints;
    traits.forEach(t => { if (TRAIT_COSTS[t] !== undefined) total += TRAIT_COSTS[t]; });
    abilities.forEach(a => { if (ABILITY_COSTS[a] !== undefined) total += ABILITY_COSTS[a]; });
    document.getElementsByName('Points')[0].value = total;
}
</script>
</form>
</body>
</html>
