{% set trait_effects_dict = {} %}
{% for trait in traits %}
    {% set _ = trait_effects_dict.update({trait['name']: trait['effect']}) %}
{% endfor %}

{% set ability_effects_dict = {} %}
{% for ab in abilities %}
    {% set _ = ability_effects_dict.update({ab['name']: ab['effect']}) %}
{% endfor %}

<!DOCTYPE html>
<html>
<head>
    <title>Edit Character - {{ character['Name'] }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .sheet-box {
            border: 3px solid #000;
            width: 580px;
            margin: 36px auto 24px auto;
            padding: 0;
            background: #fff;
            overflow: hidden;
        }
        .sheet-row, .sheet-header, .sheet-section {
            border-bottom: 1px solid #000;
            padding: 10px 18px;
        }
        .sheet-header { 
            text-align: center; 
            font-weight: bold; 
            font-size: 1.2em; 
            background: #fff; 
            border-bottom: 1px solid #000; 
        }
        .sheet-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        .sheet-table th, .sheet-table td {
            border: 1px solid #000;
            text-align: center;
            padding: 2px 4px;
        }
        .sheet-section-title { font-weight: bold; margin-top: 4px; margin-bottom: 6px; }
        .sheet-flex { display: flex; gap: 0; }
        .sheet-half { 
            width: 50%; 
            border-right: 1px solid #000; 
            box-sizing: border-box; 
            background: #fff;
            padding: 10px;
        }
        .sheet-half:last-child { border-right: none; }
        .sheet-list { min-height: 40px; margin: 0; padding-left: 16px; }
        .sheet-list li { text-align: left; }
        .sheet-label { font-weight: bold; }
        .sheet-row:last-child, .sheet-section:last-child { border-bottom: none; }
        .btn { 
            padding: 8px 18px; 
            border-radius: 0; 
            border: 1px solid #000; 
            background: #fff; 
            color: #000; 
            font-weight: bold; 
            text-decoration: none; 
            margin-right: 8px; 
        }
        .btn:hover { background: #eee; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            border-radius: 0;
            border: 1px solid #000;
            padding: 5px 7px;
            background: #fff;
        }
        /* Style for trait/ability dropdown options */
        select option {
            padding: 8px 6px;
            white-space: normal;
            min-height: 30px;
            line-height: 1.3;
        }
        textarea {
            border-radius: 0;
        }
    </style>
</head>
<body style="background:#f4f4f4;">
<div style="text-align:center;margin-bottom:10px;font-size:1.1em;">
    <b>Warband Points Limit:</b> {{ warband_points }}
</div>

<form action="/edit_character/{{ warband }}/{{ character['Name'] }}" method="post" autocomplete="off">
    <div class="sheet-box">
        <div class="sheet-header">Character Sheet</div>
        
        <div class="sheet-row">
            <table class="sheet-table" style="border-collapse: collapse;">
                <tr>
                    <td style="width:70%; text-align:left; padding:8px;"><b>Name:</b> <input type="text" name="Name" value="{{ character['Name'] }}" style="width:calc(100% - 60px); font-weight:bold; font-size:1em; border:1px solid #888; padding:2px 4px;"></td>
                    <td style="width:30%; text-align:left; padding:8px;"><b>Points cost:</b> <input type="number" name="Points" value="{{ character['Points'] }}" style="width:60px;"></td>
                </tr>
            </table>
        </div>

        <div class="sheet-row">
            <table class="sheet-table">
                <tr><th>Agility</th><th>Shooting</th><th>Fighting</th><th>Psyche</th><th>Awareness</th></tr>
                <tr>
                    <td><input type="number" name="Agility" value="{{ character['Skills']['Agility'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Shooting" value="{{ character['Skills']['Shooting'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Fighting" value="{{ character['Skills']['Fighting'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Psyche" value="{{ character['Skills']['Psyche'] }}" style="width:40px;"></td>
                    <td><input type="number" name="Awareness" value="{{ character['Skills']['Awareness'] }}" style="width:40px;"></td>
                </tr>
            </table>
        </div>

        <div class="sheet-row">
            <table class="sheet-table">
                <tr><td>Speed</td><td>Hit-points</td></tr>
                <tr>
                    <td><input type="number" name="Speed" value="{{ character['Speed'] }}" style="width:60px;"></td>
                    <td><input type="number" name="Hitpoints" value="{{ character['Hit-points'] }}" style="width:60px;"></td>
                </tr>
            </table>
        </div>
        
        <div class="sheet-section">
            <div class="sheet-section-title">Traits:</div>
            <div id="trait-list-box" style="min-height: 80px; border: 1px solid #000; padding: 8px;">
                <input type="hidden" name="Traits" id="traits-hidden-input" value="{{ character['Traits']|join(',') }}">
                <ul id="trait-list" class="sheet-list" style="margin-bottom:6px;">
                    {% for trait in character['Traits'] %}
                    <li>
                        {{ trait }}
                        <button type="button" class="show-effect-btn" data-trait="{{ trait }}" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>
                        <button type="button" class="remove-trait-btn" data-trait="{{ trait }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>
                        <div class="trait-effect-inline" data-trait="{{ trait }}" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
                    </li>
                    {% else %}
                    <li>-</li>
                    {% endfor %}
                </ul>
                <button type="button" id="toggle-all-trait-effects" style="margin:6px 0 8px 0;padding:2px 12px;font-size:0.97em;">Show all trait effects</button>
                <div id="all-trait-effects" style="display:none;margin:8px 0 0 0;padding:8px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            </div>
            <div style="margin-top:8px;display:flex;align-items:center;">
                <label for="trait_select" style="margin-right:8px;white-space:nowrap;"><b>Add Trait:</b></label>
                <select id="trait_select" onchange="traitEffect();" style="flex-grow:1;margin-right:5px;">
                    <option value="">-- Select a trait --</option>
                    {% for trait in traits %}
                    <option value="{{ trait['name'] }}" data-effect="{{ trait['effect'] }}">{{ trait['name'] }} ({{ trait['cost'] }}) [{{ trait['effect'] }}]</option>
                    {% endfor %}
                </select>
                <button type="button" id="add-trait-btn">Add</button>
                <div id="trait-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;width:100%;"></div>
            </div>
        </div>
        
        <div class="sheet-section">
            <div class="sheet-section-title">Abilities:</div>
            <div id="ability-list-box" style="min-height: 80px; border: 1px solid #000; padding: 8px;">
                <input type="hidden" name="Abilities" id="abilities-hidden-input" value="{{ character['Abilities']|join(',') }}">
                <ul id="ability-list" class="sheet-list" style="margin-bottom:6px;">
                {% for ab in character['Abilities'] %}
                    <li>
                        <div>{{ ab }}</div>
                        <button type="button" class="show-ability-effect-btn" data-ability="{{ ab }}" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>
                        <button type="button" class="remove-ability-btn" data-ability="{{ ab }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>
                        <div class="ability-effect-inline" data-ability="{{ ab }}" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
                    </li>
                {% else %}
                    <li>-</li>
                {% endfor %}
                </ul>
                <button type="button" id="toggle-all-ability-effects" style="margin:6px 0 8px 0;padding:2px 12px;font-size:0.97em;">Show all ability effects</button>
                <div id="all-ability-effects" style="display:none;margin:8px 0 0 0;padding:8px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            </div>
            <div style="margin-top:8px;display:flex;align-items:center;">
                <label for="ability_select" style="margin-right:8px;white-space:nowrap;"><b>Add Ability:</b></label>
                <select id="ability_select" onchange="abilityEffect();" style="flex-grow:1;margin-right:5px;">
                    <option value="">-- Select an ability --</option>
                    {% for ab in abilities %}
                    <option value="{{ ab['name'] }}" data-effect="{{ ab['effect'] }}">{{ ab['name'] }} ({{ ab['cost'] }}) [{{ ab['effect'] }}]</option>
                    {% endfor %}
                </select>
                <button type="button" id="add-ability-btn">Add</button>
                <div id="ability-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;width:100%;"></div>
            </div>
        </div>
        
        <div class="sheet-row">
            <div class="sheet-flex">
                <div class="sheet-half">
                    <div class="sheet-section-title">Equipment:</div>
                    <div style="min-height: 150px; border: 1px solid #000; padding: 8px;">
                        <textarea name="Equipment" rows="7" style="width:100%;height:134px;resize:none;border:none;background:transparent;padding:0;">{{ character['Equipment']|join(', ') if character['Equipment'] else '' }}</textarea>
                    </div>
                </div>
                <div class="sheet-half">
                    <div class="sheet-section-title">Injuries:</div>
                    <div style="min-height: 100px; border: 1px solid #000; padding: 8px;">
                        <textarea name="Injuries" rows="4" style="width:100%;height:84px;resize:none;border:none;background:transparent;padding:0;">{{ character['Injuries'] if character['Injuries'] is defined else '' }}</textarea>
                    </div>
                    <div class="sheet-section-title" style="margin-top:10px;">Campaign points:</div>
                    <div style="min-height: 40px; border: 1px solid #000; padding: 8px;">
                        <input type="text" name="CampaignPoints" value="{{ character['CampaignPoints'] if character['CampaignPoints'] is defined else '' }}" style="width:100%;height:24px;border:none;background:transparent;padding:0;">
                    </div>
                </div>
            </div>
        </div>
        
        <div style="margin-top:16px;">
            <div class="sheet-section-title">Notes:</div>
            <textarea name="Notes" rows="2" style="width:100%;min-height:40px;resize:vertical;border:1px solid #000;padding:6px 8px;box-sizing:border-box;">{{ character['Notes'] if character['Notes'] is defined else '' }}</textarea>
        </div>

        <div style="margin-top:16px;">
            <div class="sheet-section-title">Backstory:</div>
            <textarea name="Backstory" rows="3" style="width:100%;min-height:60px;resize:vertical;border:1px solid #000;padding:6px 8px;box-sizing:border-box;">{{ character['Backstory'] if character['Backstory'] is defined else '' }}</textarea>
        </div>

        <div style="margin-top:16px;text-align:center;">
            <span id="save-status" style="margin-right:10px;font-size:0.9em;color:#666;display:inline-block;width:150px;text-align:right;"></span>
            <button type="submit" style="padding:8px 24px;font-weight:bold;background:#222;color:white;border:none;border-radius:4px;">Save Character</button>
        </div>
    </div>

<script id="trait-costs-json" type="application/json">
{
{% for trait in traits %}    "{{ trait['name'] }}": {{ trait['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>

<script id="ability-costs-json" type="application/json">
{
{% for ab in abilities %}    "{{ ab['name'] }}": {{ ab['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>

<script>
// Map trait and ability names to effects for quick lookup
const TRAIT_EFFECTS = {{ trait_effects_dict|tojson|safe }};
const ABILITY_EFFECTS = {{ ability_effects_dict|tojson|safe }};
const TRAIT_COSTS = JSON.parse(document.getElementById('trait-costs-json').textContent);
const ABILITY_COSTS = JSON.parse(document.getElementById('ability-costs-json').textContent);

document.addEventListener('DOMContentLoaded', function() {
    const traitSelect = document.getElementById('trait_select');
    const abilitySelect = document.getElementById('ability_select');
    const traitList = document.getElementById('trait-list');
    const abilityList = document.getElementById('ability-list');
    const traitInput = document.getElementById('traits-hidden-input');
    const abilityInput = document.getElementById('abilities-hidden-input');
    const toggleTraitBtn = document.getElementById('toggle-all-trait-effects');
    const toggleAbilityBtn = document.getElementById('toggle-all-ability-effects');
    const traitEffectsDiv = document.getElementById('all-trait-effects');
    const abilityEffectsDiv = document.getElementById('all-ability-effects');
    const saveStatusElement = document.getElementById('save-status');
    
    console.log("DOM loaded, elements initialized:");
    console.log("abilityList:", abilityList ? "found" : "not found");
    console.log("abilityEffectsDiv:", abilityEffectsDiv ? "found" : "not found");
    console.log("toggleAbilityBtn:", toggleAbilityBtn ? "found" : "not found");
    
    // Auto-save variables
    let saveTimeout = null;
    const SAVE_DELAY = 1500; // 1.5 seconds after last change
    
    // Variables to track if effect tables are shown
    let traitEffectsShown = false;
    let abilityEffectsShown = false;
    
    // Trait effects toggle
    if (toggleTraitBtn && traitEffectsDiv) {
        toggleTraitBtn.addEventListener('click', function() {
            if (!traitEffectsShown) {
                updateTraitEffectsDisplay();
                traitEffectsDiv.style.display = 'block';
                toggleTraitBtn.textContent = 'Hide all trait effects';
                traitEffectsShown = true;
            } else {
                traitEffectsDiv.style.display = 'none';
                toggleTraitBtn.textContent = 'Show all trait effects';
                traitEffectsShown = false;
            }
        });
    }
    
    // Ability effects toggle
    if (toggleAbilityBtn && abilityEffectsDiv) {
        toggleAbilityBtn.addEventListener('click', function() {
            if (!abilityEffectsShown) {
                updateAbilityEffectsDisplay();
                abilityEffectsDiv.style.display = 'block';
                toggleAbilityBtn.textContent = 'Hide all ability effects';
                abilityEffectsShown = true;
            } else {
                abilityEffectsDiv.style.display = 'none';
                toggleAbilityBtn.textContent = 'Show all ability effects';
                abilityEffectsShown = false;
            }
        });
    }

    // Function to update trait effects display
    function updateTraitEffectsDisplay() {
        console.log("Updating trait effects display");
        // Get all current traits from the list
        const traitNames = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).map(btn => btn.getAttribute('data-trait'));
        console.log("Current traits:", traitNames);
        
        // Build HTML for display
        let html = '';
        if (traitNames.length === 0) {
            html = '<div>No traits added yet.</div>';
        } else {
            traitNames.forEach(trait => {
                if (TRAIT_EFFECTS[trait]) {
                    html += `<div style="margin-bottom:6px;"><b>${trait}</b>: ${TRAIT_EFFECTS[trait]}</div>`;
                } else {
                    html += `<div style="margin-bottom:6px;"><b>${trait}</b>: No effect description available.</div>`;
                }
            });
        }
        
        // Update the content
        traitEffectsDiv.innerHTML = html;
    }
    
    // Function to update ability effects display
    function updateAbilityEffectsDisplay() {
        console.log("Updating ability effects display");
        // Get all current abilities from the list
        const abilityNames = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).map(btn => btn.getAttribute('data-ability'));
        console.log("Current abilities:", abilityNames);
        
        // Build HTML for display
        let html = '';
        if (abilityNames.length === 0) {
            html = '<div>No abilities added yet.</div>';
        } else {
            abilityNames.forEach(ability => {
                if (ABILITY_EFFECTS[ability]) {
                    html += `<div style="margin-bottom:6px;"><b>${ability}</b>: ${ABILITY_EFFECTS[ability]}</div>`;
                } else {
                    html += `<div style="margin-bottom:6px;"><b>${ability}</b>: No effect description available.</div>`;
                }
            });
        }
        
        // Update the content
        abilityEffectsDiv.innerHTML = html;
    }
    
    // Auto-save function
    function scheduleSave() {
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }
        
        saveStatusElement.textContent = "Changes detected...";
        saveStatusElement.style.color = "#666";
        
        saveTimeout = setTimeout(function() {
            saveCharacter();
        }, SAVE_DELAY);
    }
    
    // Function to save character data via AJAX
    function saveCharacter() {
        saveStatusElement.textContent = "Saving...";
        
        const form = document.querySelector('form');
        const formData = new FormData(form);
        
        // Debug logging for form data
        console.log("Saving traits:", formData.get('Traits'));
        console.log("Saving abilities:", formData.get('Abilities'));
        
        // Create and send the AJAX request
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                saveStatusElement.textContent = "Saved";
                saveStatusElement.style.color = "#090";
                
                // Fade out the status after 3 seconds
                setTimeout(function() {
                    let opacity = 1;
                    const fadeInterval = setInterval(function() {
                        opacity -= 0.1;
                        if (opacity <= 0) {
                            saveStatusElement.textContent = "";
                            clearInterval(fadeInterval);
                        } else {
                            saveStatusElement.style.opacity = opacity;
                        }
                    }, 100);
                }, 3000);
                
                return response.text();
            } else {
                throw new Error('Save failed');
            }
        })
        .catch(error => {
            saveStatusElement.textContent = "Auto-save failed";
            saveStatusElement.style.color = "#c00";
            console.error('Error saving character:', error);
        });
    }
    
    // --- TRAIT ADD/REMOVE ---
    function updateTraitsInput() {
        const traits = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).map(btn => btn.getAttribute('data-trait'));
        
        // Ensure we're setting an empty string if there are no traits
        traitInput.value = traits.length > 0 ? traits.join(',') : '';
        console.log("Updated traits input value:", traitInput.value);
        
        // Update trait effects display if it's visible
        if (traitEffectsShown) {
            updateTraitEffectsDisplay();
        }
        
        // Trigger auto-save
        scheduleSave();
    }
    
    // Event delegation for removing traits
    if (traitList) {
        traitList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-trait-btn')) {
                e.target.parentNode.remove();
                updateTraitsInput();
                
                // If no traits left, show a dash
                if (traitList.children.length === 0) {
                    var dash = document.createElement('li');
                    dash.textContent = '-';
                    traitList.appendChild(dash);
                }
            } else if (e.target.classList.contains('show-effect-btn')) {
                const trait = e.target.getAttribute('data-trait');
                const effectDiv = e.target.parentNode.querySelector(`.trait-effect-inline[data-trait="${trait}"]`);
                if (effectDiv) {
                    if (effectDiv.style.display === 'none') {
                        effectDiv.style.display = 'block';
                        effectDiv.textContent = TRAIT_EFFECTS[trait] || 'No effect description available.';
                    } else {
                        effectDiv.style.display = 'none';
                    }
                }
            }
        });
    }
    
    // Add trait button
    var addTraitBtn = document.getElementById('add-trait-btn');
    if (addTraitBtn) {
        addTraitBtn.addEventListener('click', function() {
            var select = document.getElementById('trait_select');
            var trait = select.value;
            if (!trait) return;
            // Prevent duplicates
            var exists = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).some(btn => btn.getAttribute('data-trait') === trait);
            if (exists) return;
            // Remove dash if present
            var traitList = document.getElementById('trait-list');
            if (traitList.children.length === 1 && traitList.children[0].textContent === '-') {
                traitList.removeChild(traitList.children[0]);
            }
            var li = document.createElement('li');
            li.innerHTML = '<div>' + trait + '</div>' + 
                '<button type="button" class="show-effect-btn" data-trait="' + trait + '" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>' +
                '<button type="button" class="remove-trait-btn" data-trait="' + trait + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>' +
                '<div class="trait-effect-inline" data-trait="' + trait + '" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;">' + TRAIT_EFFECTS[trait] + '</div>';
            traitList.appendChild(li);
            updateTraitsInput();
            
            // If showing all effects, update the display
            if (traitEffectsShown) {
                updateTraitEffectsDisplay();
            }
            
            select.selectedIndex = 0;
            document.getElementById('trait-effect-preview').style.display = 'none';
        });
    }
    
    // --- ABILITY ADD/REMOVE ---
    function updateAbilitiesInput() {
        const abilities = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).map(btn => btn.getAttribute('data-ability'));
        
        // Ensure we're setting an empty string if there are no abilities
        abilityInput.value = abilities.length > 0 ? abilities.join(',') : '';
        console.log("Updated abilities input value:", abilityInput.value);
        
        // Update ability effects display if it's visible
        if (abilityEffectsShown) {
            updateAbilityEffectsDisplay();
        }
        
        updatePoints();
        
        // Trigger auto-save
        scheduleSave();
    }
    
    // Event delegation for ability removal
    if (abilityList) {
        abilityList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-ability-btn')) {
                e.target.parentNode.remove();
                updateAbilitiesInput();
                
                // If no abilities left, show a dash
                if (abilityList.children.length === 0) {
                    var dash = document.createElement('li');
                    dash.textContent = '-';
                    abilityList.appendChild(dash);
                }
            } else if (e.target.classList.contains('show-ability-effect-btn')) {
                const ability = e.target.getAttribute('data-ability');
                const effectDiv = e.target.parentNode.querySelector(`.ability-effect-inline[data-ability="${ability}"]`);
                if (effectDiv) {
                    if (effectDiv.style.display === 'none') {
                        effectDiv.style.display = 'block';
                        effectDiv.textContent = ABILITY_EFFECTS[ability] || 'No effect description available.';
                    } else {
                        effectDiv.style.display = 'none';
                    }
                }
            }
        });
    }
    
    // Add ability button
    var addAbilityBtn = document.getElementById('add-ability-btn');
    if (addAbilityBtn) {
        addAbilityBtn.addEventListener('click', function() {
            var select = document.getElementById('ability_select');
            var ability = select.value;
            if (!ability) return;
            // Prevent duplicates
            var exists = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).some(btn => btn.getAttribute('data-ability') === ability);
            if (exists) return;
            // Remove dash if present
            var abilityList = document.getElementById('ability-list');
            if (abilityList.children.length === 1 && abilityList.children[0].textContent === '-') {
                abilityList.removeChild(abilityList.children[0]);
            }
            var li = document.createElement('li');
            li.innerHTML = '<div>' + ability + '</div>' + 
                '<button type="button" class="show-ability-effect-btn" data-ability="' + ability + '" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>' +
                '<button type="button" class="remove-ability-btn" data-ability="' + ability + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>' +
                '<div class="ability-effect-inline" data-ability="' + ability + '" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;">' + ABILITY_EFFECTS[ability] + '</div>';
            abilityList.appendChild(li);
            updateAbilitiesInput();
            
            // If showing all effects, update the display
            if (abilityEffectsShown) {
                updateAbilityEffectsDisplay();
            }
            
            select.selectedIndex = 0;
            document.getElementById('ability-effect-preview').style.display = 'none';
        });
    }
    
    // Initialize points calculation
    updatePoints();
});

// Show effect preview for selected trait
function traitEffect() {
    var select = document.getElementById('trait_select');
    var preview = document.getElementById('trait-effect-preview');
    var effect = select.options[select.selectedIndex].getAttribute('data-effect');
    // We're already showing the effect in the dropdown option text,
    // so we'll only show the preview if explicitly wanted
    if (effect && select.value) {
        preview.style.display = 'none'; // Changed to hide by default since effect is in dropdown
    } else {
        preview.style.display = 'none';
        preview.textContent = '';
    }
}

// Show effect preview for selected ability
function abilityEffect() {
    var select = document.getElementById('ability_select');
    var preview = document.getElementById('ability-effect-preview');
    var effect = select.options[select.selectedIndex].getAttribute('data-effect');
    // We're already showing the effect in the dropdown option text,
    // so we'll only show the preview if explicitly wanted
    if (effect && select.value) {
        preview.style.display = 'none'; // Changed to hide by default since effect is in dropdown
    } else {
        preview.style.display = 'none';
        preview.textContent = '';
    }
}

// Calculate points based on traits and abilities
function updatePoints() {
    let basePoints = 10; // base cost
    let traitInput = document.getElementById('traits-hidden-input').value;
    let abilityInput = document.getElementById('abilities-hidden-input').value;
    let traits = traitInput.split(',').map(x => x.trim()).filter(x => x);
    let abilities = abilityInput.split(',').map(x => x.trim()).filter(x => x);
    let total = basePoints;
    traits.forEach(t => { if (TRAIT_COSTS[t] !== undefined) total += TRAIT_COSTS[t]; });
    abilities.forEach(a => { if (ABILITY_COSTS[a] !== undefined) total += ABILITY_COSTS[a]; });
    document.getElementsByName('Points')[0].value = total;
    
    // Trigger auto-save when points are updated
    scheduleSave();
}

// Add event listeners to all form inputs for auto-save
document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
    input.addEventListener('change', scheduleSave);
    input.addEventListener('blur', scheduleSave);
});

// Handle special case for Notes and Backstory fields - save on typing with delay
const notesField = document.querySelector('textarea[name="Notes"]');
if (notesField) {
    notesField.addEventListener('input', function() {
        scheduleSave();
    });
}

const backstoryField = document.querySelector('textarea[name="Backstory"]');
if (backstoryField) {
    backstoryField.addEventListener('input', function() {
        scheduleSave();
    });
}
</script>
</form>
</body>
</html>
