<!DOCTYPE html>
<html>
<head>
    <title>Edit Character - {{ character['Name'] }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .sheet-box {
            border: 2px solid #222;
            width: 520px;
            margin: 36px auto 24px auto;
            padding: 0;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px #0002;
            overflow: hidden;
        }
        .sheet-row, .sheet-header, .sheet-section {
            border-bottom: 1.5px solid #bbb;
            padding: 10px 18px;
        }
        .sheet-header { text-align: center; font-weight: bold; font-size: 1.18em; background: #f8f8f8; border-bottom: 2px solid #222; }
        .sheet-table { width: 100%; border-collapse: collapse; }
        .sheet-table th, .sheet-table td {
            border: 1px solid #000;
            text-align: center;
            padding: 2px 4px;
        }
    .sheet-section-title { font-weight: bold; margin-top: 4px; margin-bottom: 6px; }
    .sheet-flex { display: flex; gap: 0; }
    .sheet-half { width: 50%; border-right: 1.5px solid #bbb; box-sizing: border-box; background: #fafbfc; }
    .sheet-half:last-child { border-right: none; }
    .sheet-quarter-inner { padding: 10px 12px; min-height: 40px; }
        .sheet-list { min-height: 40px; margin: 0; padding-left: 16px; }
        .sheet-list li { text-align: left; }
        .sheet-label { font-weight: bold; }
        .sheet-row:last-child, .sheet-section:last-child { border-bottom: none; }
    .sheet-nav { text-align: center; margin: 22px 0 0 0; }
        .btn { padding: 8px 18px; border-radius: 4px; border: none; background: #222; color: #fff; font-weight: bold; text-decoration: none; margin-right: 8px; }
        .btn:hover { background: #444; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #bbb;
            padding: 5px 7px;
            background: #f9f9f9;
        }
    </style>
</head>
<body style="background:#f4f4f4;">
<div style="text-align:center;margin-bottom:10px;font-size:1.1em;">
    <b>Warband Points Limit:</b> {{ warband_points }}
</div>
<form action="/edit_character/{{ warband }}/{{ character['Name'] }}" method="post" autocomplete="off">
<div class="sheet-box">
    <div class="sheet-header">Edit Character: <input type="text" name="Name" value="{{ character['Name'] }}" style="width:120px; font-weight:bold; font-size:1em; border:1px solid #888; padding:2px 4px;"> </div>
    <div class="sheet-row">
        <span class="sheet-label">Points cost:</span>
        <input type="number" name="Points" value="{{ character['Points'] }}" style="width:60px;">
    </div>
    <div class="sheet-row">
        <table class="sheet-table">
            <tr><th>Agility</th><th>Shooting</th><th>Fighting</th><th>Psyche</th><th>Awareness</th></tr>
            <tr>
                <td><input type="number" name="Agility" value="{{ character['Skills']['Agility'] }}" style="width:40px;"></td>
                <td><input type="number" name="Shooting" value="{{ character['Skills']['Shooting'] }}" style="width:40px;"></td>
                <td><input type="number" name="Fighting" value="{{ character['Skills']['Fighting'] }}" style="width:40px;"></td>
                <td><input type="number" name="Psyche" value="{{ character['Skills']['Psyche'] }}" style="width:40px;"></td>
                <td><input type="number" name="Awareness" value="{{ character['Skills']['Awareness'] }}" style="width:40px;"></td>
            </tr>
        </table>
    </div>
    <div class="sheet-row">
        <table class="sheet-table">
            <tr><td>Speed</td><td>Hit-points</td></tr>
            <tr>
                <td><input type="number" name="Speed" value="{{ character['Speed'] }}" style="width:60px;"></td>
                <td><input type="number" name="Hitpoints" value="{{ character['Hit-points'] }}" style="width:60px;"></td>
            </tr>
        </table>
    </div>
    <div class="sheet-section">
        <div class="sheet-section-title">Traits (comma separated):</div>
        <input type="text" name="Traits" value="{{ character['Traits']|join(', ') }}" style="width:100%;">
        <div style="margin-top:8px;">
            <label for="trait_select"><b>Add Trait:</b></label>
            <button type="button" id="toggle-trait-desc" style="margin-left:10px;padding:2px 10px;font-size:0.95em;">Show descriptions</button>
            <select id="trait_select" onchange="addTrait()" style="width:100%;max-width:100%;box-sizing:border-box;">
                <option value="">-- Select a trait --</option>
                {% for trait in traits %}
                <option value="{{ trait['name'] }}" data-effect="{{ trait['effect'] }}">{{ trait['name'] }} ({{ trait['cost'] }})</option>
                {% endfor %}
            </select>
            <div id="trait-desc-list" style="display:none;margin-top:8px;font-size:0.97em;color:#333;background:#f8f8f8;padding:8px 10px;border-radius:6px;border:1px solid #ddd;max-height:120px;overflow:auto;">
                <b>Trait Descriptions:</b>
                <ul style="margin:6px 0 0 0;padding-left:18px;">
                {% for trait in traits %}
                    <li><b>{{ trait['name'] }}</b>: {{ trait['effect'] }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="sheet-section">
        <div class="sheet-section-title">Abilities (comma separated):</div>
        <input type="text" name="Abilities" value="{{ character['Abilities']|join(', ') }}" style="width:100%;">
        <div style="margin-top:8px;">
            <label for="ability_select"><b>Add Ability:</b></label>
            <button type="button" id="toggle-ability-desc" style="margin-left:10px;padding:2px 10px;font-size:0.95em;">Show descriptions</button>
            <select id="ability_select" onchange="addAbility()" style="width:100%;max-width:100%;box-sizing:border-box;">
                <option value="">-- Select an ability --</option>
                {% for ab in abilities %}
                <option value="{{ ab['name'] }}" data-effect="{{ ab['effect'] }}">{{ ab['name'] }} ({{ ab['cost'] }})</option>
                {% endfor %}
            </select>
            <div id="ability-desc-list" style="display:none;margin-top:8px;font-size:0.97em;color:#333;background:#f8f8f8;padding:8px 10px;border-radius:6px;border:1px solid #ddd;max-height:120px;overflow:auto;">
                <b>Ability Descriptions:</b>
                <ul style="margin:6px 0 0 0;padding-left:18px;">
                {% for ab in abilities %}
                    <li><b>{{ ab['name'] }}</b>: {{ ab['effect'] }}</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="sheet-section" style="padding:0;">
        <div class="sheet-section-title">Notes / Background:</div>
        <div class="sheet-quarter-inner">
            <textarea name="Notes" rows="3" style="width:100%;min-height:60px;resize:vertical;border-radius:4px;border:1px solid #bbb;padding:6px 8px;box-sizing:border-box;">{{ character['Notes'] if character['Notes'] is defined else '' }}</textarea>
        </div>
        <div class="sheet-flex">
            <div class="sheet-half">
                <div class="sheet-section-title">Equipment (comma separated): <span style="color:#b00;font-size:0.9em;">(add in dev)</span></div>
                <div class="sheet-quarter-inner">
                    <input type="text" name="Equipment" value="{{ character['Equipment']|join(', ') }}">
                </div>
            </div>
            <div class="sheet-half">
                <div class="sheet-section-title">Injuries:</div>
                <div class="sheet-quarter-inner">-</div>
                <div class="sheet-section-title">Campaign points:</div>
                <div class="sheet-quarter-inner">-</div>
            </div>
        </div>
    </div>
</div>
<script id="trait-costs-json" type="application/json">
{
{% for trait in traits %}    "{{ trait['name'] }}": {{ trait['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
// Toggle trait and ability descriptions after DOM is loaded
window.addEventListener('DOMContentLoaded', function() {
    var traitBtn = document.getElementById('toggle-trait-desc');
    var traitDesc = document.getElementById('trait-desc-list');
    if (traitBtn && traitDesc) {
        traitBtn.onclick = function() {
            if (traitDesc.style.display === 'none' || traitDesc.style.display === '') {
                traitDesc.style.display = 'block';
                traitBtn.textContent = 'Hide descriptions';
            } else {
                traitDesc.style.display = 'none';
                traitBtn.textContent = 'Show descriptions';
            }
        };
    }
    var abBtn = document.getElementById('toggle-ability-desc');
    var abDesc = document.getElementById('ability-desc-list');
    if (abBtn && abDesc) {
        abBtn.onclick = function() {
            if (abDesc.style.display === 'none' || abDesc.style.display === '') {
                abDesc.style.display = 'block';
                abBtn.textContent = 'Hide descriptions';
            } else {
                abDesc.style.display = 'none';
                abBtn.textContent = 'Show descriptions';
            }
        };
    }
});
</script>
<script id="ability-costs-json" type="application/json">
{
{% for ab in abilities %}    "{{ ab['name'] }}": {{ ab['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>
<script>
const TRAIT_COSTS = JSON.parse(document.getElementById('trait-costs-json').textContent);
const ABILITY_COSTS = JSON.parse(document.getElementById('ability-costs-json').textContent);

function updatePoints() {
    let basePoints = 10; // base cost
    let traitInput = document.getElementsByName('Traits')[0].value;
    let abilityInput = document.getElementsByName('Abilities')[0].value;
    let traits = traitInput.split(',').map(x => x.trim()).filter(x => x);
    let abilities = abilityInput.split(',').map(x => x.trim()).filter(x => x);
    let total = basePoints;
    traits.forEach(t => { if (TRAIT_COSTS[t] !== undefined) total += TRAIT_COSTS[t]; });
    abilities.forEach(a => { if (ABILITY_COSTS[a] !== undefined) total += ABILITY_COSTS[a]; });
    document.getElementsByName('Points')[0].value = total;
}

function addTrait() {
    var sel = document.getElementById('trait_select');
    var val = sel.value;
    if (!val) return;
    var input = document.getElementsByName('Traits')[0];
    var arr = input.value.split(',').map(x => x.trim()).filter(x => x);
    if (arr.indexOf(val) === -1) arr.push(val);
    input.value = arr.join(', ');
    sel.selectedIndex = 0;
    updatePoints();
}
function addAbility() {
    var sel = document.getElementById('ability_select');
    var val = sel.value;
    if (!val) return;
    var input = document.getElementsByName('Abilities')[0];
    var arr = input.value.split(',').map(x => x.trim()).filter(x => x);
    if (arr.indexOf(val) === -1) arr.push(val);
    input.value = arr.join(', ');
    sel.selectedIndex = 0;
    updatePoints();
}
document.getElementsByName('Traits')[0].addEventListener('input', updatePoints);
document.getElementsByName('Abilities')[0].addEventListener('input', updatePoints);
window.addEventListener('DOMContentLoaded', updatePoints);
</script>

    <div class="sheet-nav">
        <button class="btn" type="submit">Save</button>
        <a href="/warband/{{ warband }}" class="btn">Cancel</a>
    </div>
</form>
</body>
</html>
