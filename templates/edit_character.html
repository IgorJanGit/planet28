<!DOCTYPE html>
<html>
<head>
    <title>Edit Character - {{ character['Name'] }}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; }
        .sheet-box {
            border: 2px solid #222;
            width: 520px;
            margin: 36px auto 24px auto;
            padding: 0;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 18px #0002;
            overflow: hidden;
        }
        .sheet-row, .sheet-header, .sheet-section {
            border-bottom: 1.5px solid #bbb;
            padding: 10px 18px;
        }
        .sheet-header { text-align: center; font-weight: bold; font-size: 1.18em; background: #f8f8f8; border-bottom: 2px solid #222; }
        .sheet-table { width: 100%; border-collapse: collapse; }
        .sheet-table th, .sheet-table td {
            border: 1px solid #000;
            text-align: center;
            padding: 2px 4px;
        }
    .sheet-section-title { font-weight: bold; margin-top: 4px; margin-bottom: 6px; }
    .sheet-flex { display: flex; gap: 0; }
    .sheet-half { width: 50%; border-right: 1.5px solid #bbb; box-sizing: border-box; background: #fafbfc; }
    .sheet-half:last-child { border-right: none; }
    .sheet-quarter-inner { padding: 10px 12px; min-height: 40px; }
        .sheet-list { min-height: 40px; margin: 0; padding-left: 16px; }
        .sheet-list li { text-align: left; }
        .sheet-label { font-weight: bold; }
        .sheet-row:last-child, .sheet-section:last-child { border-bottom: none; }
    .sheet-nav { text-align: center; margin: 22px 0 0 0; }
        .btn { padding: 8px 18px; border-radius: 4px; border: none; background: #222; color: #fff; font-weight: bold; text-decoration: none; margin-right: 8px; }
        .btn:hover { background: #444; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            border-radius: 4px;
            border: 1px solid #bbb;
            padding: 5px 7px;
            background: #f9f9f9;
        }
    </style>
</head>
<body style="background:#f4f4f4;">
<div style="text-align:center;margin-bottom:10px;font-size:1.1em;">
    <b>Warband Points Limit:</b> {{ warband_points }}
</div>
<form action="/edit_character/{{ warband }}/{{ character['Name'] }}" method="post" autocomplete="off">
<div class="sheet-box">
    <div class="sheet-header">Edit Character: <input type="text" name="Name" value="{{ character['Name'] }}" style="width:120px; font-weight:bold; font-size:1em; border:1px solid #888; padding:2px 4px;"> </div>
    <div class="sheet-row">
        <span class="sheet-label">Points cost:</span>
        <input type="number" name="Points" value="{{ character['Points'] }}" style="width:60px;">
    </div>
    <div class="sheet-row">
        <table class="sheet-table">
            <tr><th>Agility</th><th>Shooting</th><th>Fighting</th><th>Psyche</th><th>Awareness</th></tr>
            <tr>
                <td><input type="number" name="Agility" value="{{ character['Skills']['Agility'] }}" style="width:40px;"></td>
                <td><input type="number" name="Shooting" value="{{ character['Skills']['Shooting'] }}" style="width:40px;"></td>
                <td><input type="number" name="Fighting" value="{{ character['Skills']['Fighting'] }}" style="width:40px;"></td>
                <td><input type="number" name="Psyche" value="{{ character['Skills']['Psyche'] }}" style="width:40px;"></td>
                <td><input type="number" name="Awareness" value="{{ character['Skills']['Awareness'] }}" style="width:40px;"></td>
            </tr>
        </table>
    </div>
    <div class="sheet-row">
        <table class="sheet-table">
            <tr><td>Speed</td><td>Hit-points</td></tr>
            <tr>
                <td><input type="number" name="Speed" value="{{ character['Speed'] }}" style="width:60px;"></td>
                <td><input type="number" name="Hitpoints" value="{{ character['Hit-points'] }}" style="width:60px;"></td>
            </tr>
        </table>
    </div>
    <div class="sheet-section">
        <div class="sheet-section-title">Traits (comma separated):</div>
        <div id="trait-list-box">
            <input type="hidden" name="Traits" id="traits-hidden-input" value="{{ character['Traits']|join(', ') }}">
            <ul id="trait-list" class="sheet-list" style="margin-bottom:6px;">
            {% for trait in character['Traits'] %}
                <li>
                    {{ trait }}
                    <button type="button" class="show-effect-btn" data-trait="{{ trait }}" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>
                    <button type="button" class="remove-trait-btn" data-trait="{{ trait }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>
                    <div class="trait-effect-inline" data-trait="{{ trait }}" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
                </li>
            {% else %}
                <li>-</li>
            {% endfor %}
            </ul>
            <button type="button" id="toggle-all-trait-effects" style="margin:6px 0 8px 0;padding:2px 12px;font-size:0.97em;">Show all trait effects</button>
            <div id="all-trait-effects" style="display:none;margin:8px 0 0 0;padding:8px 12px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>

            <!-- DEBUG: Show trait_effects_dict and character['Traits'] (safe for undefined) -->
            <div style="background:#ffe;border:1px solid #cc0;padding:6px 10px;margin:8px 0 8px 0;font-size:0.95em;color:#a60;">
                <b>Debug:</b><br>
                <b>trait_effects_dict:</b> {{ trait_effects_dict|default({})|tojson }}<br>
                <b>character['Traits']:</b> {{ character['Traits']|default([])|join(', ') }}
            </div>

{% set trait_effects_dict = {} %}

{% for trait in traits %}
    {% set norm_name = trait['name']|lower|trim %}
    {% set _ = trait_effects_dict.update({norm_name: trait['effect']}) %}
{% endfor %}
<script id="trait-effects-json" type="application/json">
{{ trait_effects_dict|tojson|safe }}
</script>
<script>
// Map normalized trait names to effects for quick lookup
const TRAIT_EFFECTS = JSON.parse(document.getElementById('trait-effects-json').textContent);
function normalizeTraitName(name) {
    return name.toLowerCase().trim();
}

document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggle-all-trait-effects');
    const effectsDiv = document.getElementById('all-trait-effects');
    function updateAllTraitEffectsBox() {
        if (!effectsDiv || effectsDiv.style.display === 'none') return;
        // Get all selected traits from the list
        const traitNames = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).map(btn => btn.getAttribute('data-trait'));
        let html = '';
        traitNames.forEach(trait => {
            const norm = normalizeTraitName(trait);
            if (TRAIT_EFFECTS[norm]) {
                html += `<div style="margin-bottom:6px;"><b>${trait}</b>: ${TRAIT_EFFECTS[norm]}</div>`;
            }
        });
        effectsDiv.innerHTML = html;
    }
    if (toggleBtn && effectsDiv) {
        let shown = false;
        toggleBtn.addEventListener('click', function() {
            if (!shown) {
                updateAllTraitEffectsBox();
                effectsDiv.style.display = 'block';
                toggleBtn.textContent = 'Hide all trait effects';
                shown = true;
            } else {
                effectsDiv.style.display = 'none';
                toggleBtn.textContent = 'Show all trait effects';
                shown = false;
            }
        });
        // Live update when traits are added or removed
        const observer = new MutationObserver(function() {
            if (shown) updateAllTraitEffectsBox();
        });
        observer.observe(document.getElementById('trait-list'), { childList: true });
    }
});
</script>
        </div>
        <div style="margin-top:8px;">
            <label for="trait_select"><b>Add Trait:</b></label>
            <select id="trait_select" onchange="traitEffect();" style="width:100%;max-width:100%;box-sizing:border-box;">
                    <option value="">-- Select a trait --</option>
                {% for trait in traits %}
                <option value="{{ trait['name'] }}" data-effect="{{ trait['effect'] }}">{{ trait['name'] }} ({{ trait['cost'] }})</option>
                {% endfor %}
            </select>
                <button type="button" id="add-trait-btn" style="margin-top:6px;margin-bottom:8px;">Add Trait</button>
            <div id="trait-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            <div id="trait-desc-list" style="display:none;margin-top:8px;font-size:0.97em;color:#333;background:#f8f8f8;padding:8px 10px;border-radius:6px;border:1px solid #ddd;max-height:120px;overflow:auto;">
                <!-- Trait Descriptions removed as per request -->
            </div>
        </div>
    </div>
    <div class="sheet-section">
        <div class="sheet-section-title">Abilities (comma separated):</div>
        <div id="ability-list-box">
            <input type="hidden" name="Abilities" id="abilities-hidden-input" value="{{ character['Abilities']|join(', ') }}">
            <ul id="ability-list" class="sheet-list" style="margin-bottom:6px;">
            {% for ab in character['Abilities'] %}
                <li>{{ ab }} <button type="button" class="remove-ability-btn" data-ability="{{ ab }}" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button></li>
            {% else %}
                <li>-</li>
            {% endfor %}
            </ul>
            <button type="button" id="add-ability-btn" style="margin-top:6px;margin-bottom:8px;">Add Ability</button>
        </div>
        <div style="margin-top:8px;">
            <label for="ability_select"><b>Add Ability:</b></label>
            <select id="ability_select" onchange="abilityEffect();" style="width:100%;max-width:100%;box-sizing:border-box;">
                <option value="">-- Select an ability --</option>
                {% for ab in abilities %}
                <option value="{{ ab['name'] }}" data-effect="{{ ab['effect'] }}">{{ ab['name'] }} ({{ ab['cost'] }})</option>
                {% endfor %}
            </select>
            <div id="ability-effect-preview" style="display:none;margin:6px 0 0 0;padding:6px 10px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>
            <div id="ability-desc-list-edit" style="display:none;margin-top:8px;font-size:0.97em;color:#333;background:#f8f8f8;padding:8px 10px;border-radius:6px;border:1px solid #ddd;max-height:120px;overflow:auto;">
                <!-- Ability Descriptions removed as per request -->
            </div>
        </div>
    </div>
    <div class="sheet-section" style="padding:0;">
        <div class="sheet-section-title">Notes / Background:</div>
        <div class="sheet-quarter-inner">
            <textarea name="Notes" rows="3" style="width:100%;min-height:60px;resize:vertical;border-radius:4px;border:1px solid #bbb;padding:6px 8px;box-sizing:border-box;">{{ character['Notes'] if character['Notes'] is defined else '' }}</textarea>
        </div>
        <div class="sheet-flex">
            <div class="sheet-half">
                <div class="sheet-section-title">Equipment (comma separated): <span style="color:#b00;font-size:0.9em;">(add in dev)</span></div>
                <div class="sheet-quarter-inner">
                    <input type="text" name="Equipment" value="{{ character['Equipment']|join(', ') }}">
                </div>
            </div>
            <!-- Removed Injuries and Campaign points sections as requested -->
            </div>
        </div>
    </div>
</div>
<script id="trait-costs-json" type="application/json">
{
{% for trait in traits %}    "{{ trait['name'] }}": {{ trait['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}

</script>
<script>

// Trait remove logic, add trait, and per-trait show/hide effect button logic
window.addEventListener('DOMContentLoaded', function() {
    // Remove trait button logic
    function updateTraitsInput() {
        var traits = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn'))
            .map(btn => btn.getAttribute('data-trait'));
        document.getElementById('traits-hidden-input').value = traits.join(', ');
    }
    document.getElementById('trait-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-trait-btn')) {
            var li = e.target.parentElement;
            li.parentElement.removeChild(li);
            updateTraitsInput();
        }
        if (e.target.classList.contains('show-effect-btn')) {
            var trait = e.target.getAttribute('data-trait');
            var effectDiv = e.target.parentElement.querySelector('.trait-effect-inline');
            const norm = normalizeTraitName(trait);
            if (effectDiv.style.display === 'none' || effectDiv.style.display === '') {
                effectDiv.textContent = TRAIT_EFFECTS[norm] || '';
                effectDiv.style.display = 'block';
                e.target.textContent = 'Hide';
            } else {
                effectDiv.style.display = 'none';
                e.target.textContent = '\u24D8';
            }
        }
    });
    // --- TRAIT ADD/REMOVE ---
    document.getElementById('add-trait-btn').onclick = function() {
        var select = document.getElementById('trait_select');
        var trait = select.value;
        if (!trait) return;
        // Prevent duplicates
        var exists = Array.from(document.querySelectorAll('#trait-list .remove-trait-btn')).some(btn => btn.getAttribute('data-trait') === trait);
        if (exists) return;
        var li = document.createElement('li');
        li.innerHTML = trait +
            ' <button type="button" class="show-effect-btn" data-trait="' + trait + '" style="margin-left:6px;color:#06c;background:none;border:none;font-weight:bold;cursor:pointer;">&#9432;</button>' +
            ' <button type="button" class="remove-trait-btn" data-trait="' + trait + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>' +
            '<div class="trait-effect-inline" data-trait="' + trait + '" style="display:none;margin:4px 0 0 0;padding:4px 8px;background:#f8f8f8;border-radius:6px;border:1px solid #ddd;font-size:0.97em;color:#333;"></div>';
        document.getElementById('trait-list').appendChild(li);
        updateTraitsInput();
    };
    // --- ABILITY ADD/REMOVE ---
    function updateAbilitiesInput() {
        var abilities = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn'))
            .map(btn => btn.getAttribute('data-ability'));
        document.getElementById('abilities-hidden-input').value = abilities.join(', ');
    }
    document.getElementById('ability-list').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ability-btn')) {
            var li = e.target.parentElement;
            li.parentElement.removeChild(li);
            updateAbilitiesInput();
        }
    });
    var addAbilityBtn = document.getElementById('add-ability-btn');
    if (addAbilityBtn) {
        addAbilityBtn.onclick = function() {
            var select = document.getElementById('ability_select');
            var ability = select.value;
            if (!ability) return;
            // Prevent duplicates
            var exists = Array.from(document.querySelectorAll('#ability-list .remove-ability-btn')).some(btn => btn.getAttribute('data-ability') === ability);
            if (exists) return;
            var li = document.createElement('li');
            li.innerHTML = ability + ' <button type="button" class="remove-ability-btn" data-ability="' + ability + '" style="color:#a00;background:none;border:none;font-weight:bold;cursor:pointer;">&times;</button>';
            document.getElementById('ability-list').appendChild(li);
            updateAbilitiesInput();
        };
    }
    // Trait and ability description toggles removed as per request
});
</script>
<script id="ability-costs-json" type="application/json">
{
{% for ab in abilities %}    "{{ ab['name'] }}": {{ ab['cost'] }}{% if not loop.last %},
{% endif %}{% endfor %}
}
</script>
<script>
const TRAIT_COSTS = JSON.parse(document.getElementById('trait-costs-json').textContent);
const ABILITY_COSTS = JSON.parse(document.getElementById('ability-costs-json').textContent);

function updatePoints() {
    let basePoints = 10; // base cost
    let traitInput = document.getElementsByName('Traits')[0].value;
    let abilityInput = document.getElementsByName('Abilities')[0].value;
    let traits = traitInput.split(',').map(x => x.trim()).filter(x => x);
    let abilities = abilityInput.split(',').map(x => x.trim()).filter(x => x);
    let total = basePoints;
    traits.forEach(t => { if (TRAIT_COSTS[t] !== undefined) total += TRAIT_COSTS[t]; });
    abilities.forEach(a => { if (ABILITY_COSTS[a] !== undefined) total += ABILITY_COSTS[a]; });
    document.getElementsByName('Points')[0].value = total;
}

function addTrait() {
    var sel = document.getElementById('trait_select');
    var val = sel.value;
    if (!val) return;
    var input = document.getElementsByName('Traits')[0];
    var arr = input.value.split(',').map(x => x.trim()).filter(x => x);
    if (arr.indexOf(val) === -1) arr.push(val);
    input.value = arr.join(', ');
    sel.selectedIndex = 0;
    updatePoints();
}
function addAbility() {
    var sel = document.getElementById('ability_select');
    var val = sel.value;
    if (!val) return;
    var input = document.getElementsByName('Abilities')[0];
    var arr = input.value.split(',').map(x => x.trim()).filter(x => x);
    if (arr.indexOf(val) === -1) arr.push(val);
    input.value = arr.join(', ');
    sel.selectedIndex = 0;
    updatePoints();
}
document.getElementsByName('Traits')[0].addEventListener('input', updatePoints);
document.getElementsByName('Abilities')[0].addEventListener('input', updatePoints);
window.addEventListener('DOMContentLoaded', updatePoints);
</script>

    <div class="sheet-nav">
        <button class="btn" type="submit">Save</button>
        <a href="/warband/{{ warband }}" class="btn">Cancel</a>
    </div>
</form>
</body>
</html>
